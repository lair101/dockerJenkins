#!/bin/bash
# Licensed Materials - Property of IBM
# 5724-A82
# (c) Copyright IBM Corp. 2016.
# All Rights Reserved
# US Government Users Restricted Rights - use,
# duplication or disclosure restricted by GSA
# ADP Schedule Contract with IBM Corp.
##############################################################################

##############################################################################
# main
#

# Get the install directory
MQSI_BASE_FILEPATH=$(cd -P -- "$(dirname -- "$(command -v -- "$0")")" && pwd -P)
MQSI_BASE_FILEPATH="$MQSI_BASE_FILEPATH/../.."
#
# First check whether we are using a global registry
#
if [[ -e "${MQSI_BASE_FILEPATH}/common/GLOBAL_REG" ]]
then
  read REGVAL < "${MQSI_BASE_FILEPATH}/common/GLOBAL_REG"
  GLOBAL=true
  REG_HOME="$REGVAL"
else
  GLOBAL=false
  if [[ ! -n "$REG_HOME" ]]
  then
    REG_HOME="$HOME/iibconfig"
  fi
fi
id | grep "uid=0" > /dev/null 2>&1
if [ $? -ne 0 ]; then
  OWNER="NOTROOT"
else
  OWNER="root"
fi
# Check for license
if [[ ! -e "${MQSI_BASE_FILEPATH}/license/status.dat" ]]
then
  # Set up temporary workpath and source mqsiprofile
  export MQSI_WORKPATH="/tmp/iib_install"
  mkdir -p "${MQSI_WORKPATH}/common/errors" > /dev/null 2>&1
  mkdir -p "${MQSI_WORKPATH}/common/log" > /dev/null 2>&1
  # Make MQSI_BASE_FILEPATH available for mqsiprofile
  export TEMP_MQSI_BASE_FILEPATH="${MQSI_BASE_FILEPATH}"
  . "${MQSI_BASE_FILEPATH}/server/bin/mqsiprofile" > /dev/null 2>&1
    # Before using iib you must first accept the license agreement
    mqsiexplain BIP15048 -m
    if [[ "$OWNER" == "root" ]]
    then
      # Shared installation install instructions
      mqsiexplain BIP15049 -m
    else
      # Single-user installation install instructions
      mqsiexplain BIP15050 -m
    fi
  # Clean up temporary directory
  rm -rf "/tmp/iib_install" > /dev/null 2>&1
else
  # --------------------------------------------------------------------
  # Process commands
  #
  . "${MQSI_BASE_FILEPATH}/server/bin/mqsiprofile" > /dev/null 2>&1
  java com.ibm.broker.config.util.switchcfg.CreateSwitchConfigCommand "$@"
  exit $?
fi
 
