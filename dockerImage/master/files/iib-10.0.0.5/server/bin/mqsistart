#!/bin/bash
##-----------------------------------------------------------------------------
##
##
##  Licensed Materials - Property of IBM;
##  5724-A82,5765-D66 (c) Copyright IBM Corp. 2000, 2014;
##  All Rights Reserved;
##  US Government Users Restricted Rights - use,
##  duplication or disclosure restricted by GSA
##  ADP Schedule Contract with IBM Corp.;
##
## Version  %Z% %I% %W% %E% %U% [%H% %T%]
##
##-----------------------------------------------------------------------------

# Run any profile scripts found specifically for this broker
# $1 is the broker name

# Don't do anything if no arguments are given
if [[ $# != 0 ]]
then
  # Lets check if this is a HA Broker or not
  if [ -r "${MQSI_REGISTRY}/registry/${1}/HASharedWorkPath" ]
  then
    path=$(cat ${MQSI_REGISTRY}/registry/${1}/HASharedWorkPath)
  else
    # Assume broker was not created using the -w workpath flag
    path=${MQSI_REGISTRY}                   # default location

    if  [ -r "${MQSI_REGISTRY}/registry/${1}/CurrentVersion/WorkPath" ]
    then
      # The broker has been created using -w workpath so we should look
      # and see if there are is a user created profiles directory in
      # the chosen workpath. If there is we will use that rather then the
      # default path.
      potential_path=$(cat ${MQSI_REGISTRY}/registry/${1}/CurrentVersion/WorkPath)
      if [ -d "${potential_path}/config/${1}/profiles" ]
      then
        path=${potential_path}
      fi
    fi
  fi

  # $1 is the broker name, if it does not exist skip the rest
  if [ -d "${path}/config/${1}" ]
  then
    # If there is a profiles directory for the broker run all scripts in it
    if [ -d "${path}/config/${1}/profiles" ]
    then
      for SCRIPT in ${path}/config/${1}/profiles/*.sh
      do
        if [ -r "${SCRIPT}" ]
        then
          thedate=$(date)
          echo "${thedate} - Sourcing Broker profile script ${SCRIPT} for broker ${1}" 2>&1 1>>${MQSI_REGISTRY}/common/log/${1}.profilelog
          . ${SCRIPT}
        fi
        # print out the files that have been sourced
      done
      # All profiles now read so print out the environment we will be using.Lw
      thedate=$(date)
      echo "------------------------------------------------------------------" 2>&1 1>>${MQSI_REGISTRY}/common/log/${1}.profilelog
      echo "${thedate} - The environment to be used for broker $1 :" 2>&1 1>>${MQSI_REGISTRY}/common/log/${1}.profilelog
      env 2>&1 1>>${MQSI_REGISTRY}/common/log/${1}.profilelog
      echo "------------------------------------------------------------------" 2>&1 1>>${MQSI_REGISTRY}/common/log/${1}.profilelog
    fi
  fi
fi

# Make sure ODBCUOINI is never set for broker
unset ODBCUOINI

# Set required variables into the broker's environment and attempt to run it
MQS_APPL_HANDLE_SIGNALS=1 \
MQS_NO_SYNC_SIGNAL_HANDLING=1 \
  "mqsistart.bin" "$@"
